"use strict";angular.module("protoApp",[]).config(["$routeProvider",function(e){e.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("protoApp").controller("MainCtrl",["$scope","uuid","fs",function(e,t,n){function o(n){n.stopPropagation(),n.preventDefault();for(var o,r=n.dataTransfer.files,i=0;o=r[i];i++)if(o.type.match("image.*")){var s=new FileReader;s.onload=function(n){return function(o){var r=t.get();e.screens[r]={id:r,imageName:escape(n.name),imageData:o.target.result,hotspots:[]},e.set(e.screens)}}(o),s.readAsDataURL(o)}}function r(e){e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="copy"}e.set=function(e){n.writeAppDataFile(e)},e.loadScreen=function(t){e.screens=JSON.parse(t),e.screenList=_.keys(e.screens),e.screenList=_.map(e.screenList,function(t){return{id:t,imageData:e.screens[t].imageData,imageName:e.screens[t].imageName}}),e.screenList[0]&&(e.screen=e.screens[e.screenList[0].id],e.$apply()),n.download(e)},e.spotId=null;var i=!1,s=null;n.requestForFile(e.loadScreen),e.editMode=!0,e.changeMode=function(){e.editMode=!e.editMode},e.changeScreen=function(t){e.screen=e.screens[t]},e.deleteScreen=function(t){delete e.screens[t],e.set(e.screens)},e.addSpot=function(t,n){e.screens[n].hotspots.push({top:t.offsetY-28,left:t.offsetX-2,width:150,height:30,target:null}),e.set(e.screens)},e.deleteSpot=function(t,n){e.screens[t].hotspots.splice(n,1),e.set(e.screens)},e.selectTarget=function(t,n){i=!0,s=t,e.spotId=n},e.selectScreen=function(t){i?(e.screens[s].hotspots[e.spotId].target=t,i=!1,s=null,e.spotId=null,e.set(e.screens)):e.changeScreen(t)};var a=document.getElementById("drop_zone");a.addEventListener("dragover",r,!1),a.addEventListener("drop",o,!1)}]),angular.module("protoApp").directive("draggable",function(){return{restrict:"A",link:function(e,t,n){$(t).draggable({handle:"span.handle",stop:function(t,o){e.$parent.screens[n.screen].hotspots[n.id].top=o.position.top,e.$parent.screens[n.screen].hotspots[n.id].left=o.position.left,console.log(e.$parent.screens[n.screen].hotspots[n.id]),e.$parent.set(e.$parent.screens)}})}}}),angular.module("protoApp").directive("resizable",function(){return{restrict:"A",link:function(e,t,n){$(t).resizable({stop:function(t,o){e.$parent.screens[n.screen].hotspots[n.id].width=o.size.width,e.$parent.screens[n.screen].hotspots[n.id].height=o.size.height,console.log(e.$parent.screens[n.screen].hotspots[n.id]),e.$parent.set(e.$parent.screens)}})}}}),angular.module("protoApp").directive("popover",function(){return{restrict:"A",link:function(e,t){$(t).popover()}}}),angular.module("protoApp").directive("tooltip",function(){return{restrict:"A",link:function(e,t){$(t).tooltip()}}}),angular.module("protoApp").factory("uuid",function(){function e(){var e,t,n=[],o="0123456789ABCDEF";for(e=0;36>e;e++)n[e]=Math.floor(16*Math.random());for(n[14]=4,n[19]=8|3&n[19],t=0;36>t;t++)n[t]=o[n[t]];return n[8]=n[13]=n[18]=n[23]="-",n.join("")}return{get:e}}),angular.module("protoApp").factory("fs",function(){function e(e){window.webkitStorageInfo.requestQuota(PERSISTENT,10485760,function(n){window.requestFileSystem(PERSISTENT,n,function(n){i=n,i.root.getFile("appdata.txt",{create:!0,exclusive:!1},function(){t(e)},o)},o)},function(e){console.log("Error",e)})}function t(e){i.root.getFile("appdata.txt",{create:!1},function(t){t.file(function(t){var n=new FileReader;n.onloadend=function(){console.log('File read: "'+this.result+'"'),e(this.result||"{}")},n.readAsText(t)},o)},o)}function n(e){i.root.getFile("appdata.txt",{},function(e){e.remove(function(){console.log("File removed.")},o)},o),window.webkitStorageInfo.requestQuota(PERSISTENT,104857600,function(t){window.requestFileSystem(PERSISTENT,t,function(t){i=t,i.root.getFile("appdata.txt",{create:!0,exclusive:!1},function(t){t.createWriter(function(t){t.onwriteend=function(){console.log("Write completed.")},t.onerror=function(e){console.log("Write failed: "+(""+e))};var n=new Blob([JSON.stringify(e)],{type:"text/plain"});t.write(n),console.log(n)},o)},o)},o)},function(e){console.log("Error",e)})}function o(e){var t="";switch(e.code){case FileError.QUOTA_EXCEEDED_ERR:t="QUOTA_EXCEEDED_ERR";break;case FileError.NOT_FOUND_ERR:t="NOT_FOUND_ERR";break;case FileError.SECURITY_ERR:t="SECURITY_ERR";break;case FileError.INVALID_MODIFICATION_ERR:t="INVALID_MODIFICATION_ERR";break;case FileError.INVALID_STATE_ERR:t="INVALID_STATE_ERR";break;default:t="Unknown Error"}console.log("Error: "+t)}function r(e){Downloadify.create("downloadFile",{filename:function(){return"appdata.txt"},data:JSON.stringify(e.screens),onComplete:function(){alert("Your File Has Been Saved!")},onCancel:function(){alert("You have cancelled the saving of this file.")},onError:function(){alert("You must put something in the File Contents or there will be nothing to save!")},swf:"components/downloadify/downloadify.swf",downloadImage:"images/download.png",width:100,height:30,transparent:!0,append:!1})}window.requestFileSystem=window.requestFileSystem||window.webkitRequestFileSystem;var i=null;return{requestForFile:e,writeAppDataFile:n,download:r}});